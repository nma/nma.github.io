
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Testing Custom Linux Kernels on Vagrant.</title>
	<meta name="author" content="Nick Ma">
	<link href='/assets/themes/the-minimum/css/style.css' rel="stylesheet" media="all">
	<link href="http://feeds.feedburner.com/" rel="alternate" title="Testing Custom Linux Kernels on Vagrant." type="application/atom+xml">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.0.6/modernizr.min.js"></script>
</head>
<body>

<div id="page" class="hentry">
	<header class="the-header">
		<div class="unit-head">
			<div class="unit-inner unit-head-inner">
				<p class="logo"><a href="/">Nick Ma's Blog</a></p>
				<nav class="nav-global">
					<ul>
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



					</ul>
				</nav>
			</div><!-- unit-inner -->
		</div><!-- unit-head -->
	</header>
	<div class="body" role="main">
		<div class="unit-body">
			<div class="unit-inner unit-body-inner">
				<div class="entry-content">
					
<article class="unit-article layout-post">
	<div class="unit-inner unit-article-inner">
		<div class="content">
			<header>
				<div class="unit-head">
					<div class="unit-inner unit-head-inner">
						<h1 class="h2 entry-title">Testing Custom Linux Kernels on Vagrant.</h1>
					</div><!-- unit-inner -->
				</div><!-- unit-head -->
			</header>

			<div class="bd">
				<div class="entry-content">
          <div class="social">
            <ul class="list-linear">
              <li><div class="twitter-tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="NickMa38" data-lang="en">Tweet</a></div></li>
              <li><div class="twitter-follow"><a href="https://twitter.com/NickMa38" class="twitter-follow-button" data-show-count="false" data-lang="en"></a></div></li>
            </ul>
          </div>
					<p>A friend was building a custom Ubuntu kernel and after installing the new kernel on the machine the login page refused to work.</p>

<p>After reading about vagrant and working with virtual machines, I felt that testing major OS changes will definitely be beneficial on a virtual machine. So this blog post details my attempt (vain or not) at making a easily rebootable Vagrant environment to test potentially OS breaking changes to the kernel with out having to constantly re-install the OS on a physical machine.</p>

<p>The first step will be to setup a default box for Vagrant to work. Since I had previously downloaded a trusty32-amd machine, I will stick with that for my base box.</p>

<p>Define our Vagrantfile in the project directory should look like this.</p>

<p>VagrantFile</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># -*- mode: ruby -*-</span>
<span class='c1'># vi: set ft=ruby :</span>

<span class='c1'># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
<span class='no'>VAGRANTFILE_API_VERSION</span> <span class='o'>=</span> <span class='s2'>&quot;2&quot;</span>
<span class='no'>BOX_NAME</span> <span class='o'>=</span> <span class='no'>ENV</span><span class='o'>[</span><span class='s2'>&quot;BOX_NAME&quot;</span><span class='o'>]</span> <span class='o'>||</span> <span class='s2'>&quot;trusty32-amd&quot;</span>
<span class='no'>BOX_URI</span> <span class='o'>=</span> <span class='no'>ENV</span><span class='o'>[</span><span class='s2'>&quot;BOX_URI&quot;</span><span class='o'>]</span> <span class='o'>||</span> <span class='s2'>&quot;https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box&quot;</span> 
<span class='no'>BOX_MEMORY</span> <span class='o'>=</span> <span class='no'>ENV</span><span class='o'>[</span><span class='s2'>&quot;BOX_MEMORY&quot;</span><span class='o'>]</span> <span class='o'>||</span> <span class='mi'>512</span>
<span class='no'>BOX_HOST</span> <span class='o'>=</span> <span class='no'>ENV</span><span class='o'>[</span><span class='s2'>&quot;BOX_HOST&quot;</span><span class='o'>]</span> <span class='o'>||</span> <span class='s2'>&quot;preempt-rt&quot;</span>

<span class='no'>Vagrant</span><span class='o'>.</span><span class='n'>configure</span><span class='p'>(</span><span class='no'>VAGRANTFILE_API_VERSION</span><span class='p'>)</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>config</span><span class='o'>|</span>
  <span class='c1'># All Vagrant configuration is done here. The most common configuration</span>
  <span class='c1'># options are documented and commented below. For a complete reference,</span>
  <span class='c1'># please see the online documentation at vagrantup.com.</span>

  <span class='c1'># Every Vagrant virtual environment requires a box to build off of.</span>
  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>box</span> <span class='o'>=</span> <span class='no'>BOX_NAME</span>
  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>box_url</span> <span class='o'>=</span> <span class='no'>BOX_URI</span>

  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>host_name</span> <span class='o'>=</span> <span class='no'>BOX_HOST</span>

  <span class='c1'># Disable automatic box update checking. If you disable this, then</span>
  <span class='c1'># boxes will only be checked for updates when the user runs</span>
  <span class='c1'># `vagrant box outdated`. This is not recommended.</span>
  <span class='c1'># config.vm.box_check_update = false</span>

  <span class='c1'># Create a forwarded port mapping which allows access to a specific port</span>
  <span class='c1'># within the machine from a port on the host machine. In the example below,</span>
  <span class='c1'># accessing &quot;localhost:8080&quot; will access port 80 on the guest machine.</span>
  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>network</span> <span class='s2'>&quot;forwarded_port&quot;</span><span class='p'>,</span> <span class='ss'>guest</span><span class='p'>:</span> <span class='mi'>80</span><span class='p'>,</span> <span class='ss'>host</span><span class='p'>:</span> <span class='mi'>8080</span>

  <span class='c1'># Create a private network, which allows host-only access to the machine</span>
  <span class='c1'># using a specific IP.</span>
  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>network</span> <span class='s2'>&quot;private_network&quot;</span><span class='p'>,</span> <span class='ss'>ip</span><span class='p'>:</span> <span class='s2'>&quot;192.168.33.10&quot;</span>

  <span class='c1'># Create a public network, which generally matched to bridged network.</span>
  <span class='c1'># Bridged networks make the machine appear as another physical device on</span>
  <span class='c1'># your network.</span>
  <span class='c1'># config.vm.network &quot;public_network&quot;</span>

  <span class='c1'># If true, then any SSH connections made will enable agent forwarding.</span>
  <span class='c1'># Default value: false</span>
  <span class='c1'># config.ssh.forward_agent = true</span>

  <span class='c1'># Share an additional folder to the guest VM. The first argument is</span>
  <span class='c1'># the path on the host to the actual folder. The second argument is</span>
  <span class='c1'># the path on the guest to mount the folder. And the optional third</span>
  <span class='c1'># argument is a set of non-required options.</span>
  <span class='c1'># config.vm.synced_folder &quot;../data&quot;, &quot;/vagrant_data&quot;</span>

  <span class='c1'># Provider-specific configuration so you can fine-tune various</span>
  <span class='c1'># backing providers for Vagrant. These expose provider-specific options.</span>
  <span class='c1'># Example for VirtualBox:</span>
  <span class='c1'>#</span>
  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>provider</span> <span class='s2'>&quot;virtualbox&quot;</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>vb</span><span class='o'>|</span>
    <span class='c1'># Don&#39;t boot with headless mode</span>
    <span class='c1'># vb.gui = true</span>

    <span class='c1'># Use VBoxManage to customize the VM. For example to change memory:</span>
    <span class='n'>vb</span><span class='o'>.</span><span class='n'>customize</span> <span class='o'>[</span><span class='s2'>&quot;modifyvm&quot;</span><span class='p'>,</span> <span class='ss'>:id</span><span class='p'>,</span> <span class='s2'>&quot;--memory&quot;</span><span class='p'>,</span> <span class='no'>BOX_MEMORY</span><span class='o'>]</span>

    <span class='c1'># Allow vm to directly access the hosts pci hardware</span>
    <span class='c1'># https://www.virtualbox.org/manual/ch09.html#pcipassthrough</span>
    <span class='c1'># vb.customize [&quot;modifyvm&quot;, :id, &quot;--pciattach&quot;, &lt;CPU-architecture supported id.&gt;]</span>

  <span class='k'>end</span>
  
  <span class='n'>config</span><span class='o'>.</span><span class='n'>vm</span><span class='o'>.</span><span class='n'>provision</span> <span class='s2'>&quot;shell&quot;</span><span class='p'>,</span> <span class='ss'>path</span><span class='p'>:</span> <span class='s2'>&quot;get-linux-kernel.sh&quot;</span>
<span class='k'>end</span>
</code></pre></div>
<p>After defining our Vagrantfile, we setup a shell provisioner to automate our installation of our system.</p>

<p>get-linux-kernel.sh</p>
<div class='highlight'><pre><code class='bash'><span class='c'>#!/bin/bash</span>

<span class='c'># locate our most up to date preempt_rt kernel patch, default to 3.14 if not set</span>
<span class='nv'>PREEMPT_RT_VERSION</span><span class='o'>=</span><span class='k'>${</span><span class='nv'>PREEMPT_RT_VERSION</span><span class='k'>:-</span><span class='s2'>&quot;3.14.12-rt9&quot;</span><span class='k'>}</span>
<span class='c'># the linux kernel must match the patch version.</span>
<span class='nv'>LINUX_KERNEL_VERSION</span><span class='o'>=</span><span class='k'>${</span><span class='nv'>PREEMPT_RT_VERSION</span><span class='k'>}</span>
<span class='c'># to ensure our kernel does not contain any malware, we grab the signer&#39;s public key </span>
<span class='nv'>KERNEL_GPG_KEY</span><span class='o'>=</span><span class='k'>${</span><span class='nv'>KERNEL_GPG_KEY</span><span class='k'>:-</span><span class='s2'>&quot;00411886&quot;</span><span class='k'>}</span>

<span class='nb'>echo</span> <span class='s2'>&quot;GET KERNAL VERSION --&gt; ${PREEMPT_RT_VERSION}&quot;</span>

<span class='c'># install linux kernel manager ketchup</span>
<span class='nb'>echo</span> <span class='s2'>&quot;Attempting to install ketchup kernel manager.&quot;</span>
sudo apt-get install ketchup
<span class='nb'>cd</span> /usr/src/kernels
mkdir linux
<span class='nb'>cd </span>linux

<span class='c'># setup our loading key</span>
gpg --recv-keys <span class='k'>${</span><span class='nv'>KERNEL_GPG_KEY</span><span class='k'>}</span>

<span class='c'># grab the kernel source </span>
<span class='nb'>echo</span> <span class='s2'>&quot;Grabbing kernel version ${LINUX_KERNEL_VERSION}... (may take a while to grab source files)&quot;</span>
ketchup -r -G <span class='k'>${</span><span class='nv'>PREEMPT_RT_VERSION</span><span class='k'>}</span> &gt; /dev/null 2&gt;<span class='p'>&amp;</span>1
<span class='nb'>echo</span> <span class='s2'>&quot;Completed linux kernel source download. Now you can go configure it.&quot;</span>

<span class='c'># NOTE: ketchup command above just automating this process below...</span>

<span class='c'># get and apply the preempt-rt patch</span>
<span class='c'># wget http://www.kernel.org/pub/linux/kernel/v3.14/linux-3.14.12.tar.bz2 &gt; /dev/null 2&gt;&amp;1 </span>
<span class='c'># wget https://www.kernel.org/pub/linux/kernel/projects/rt/3.14/patch-3.14.12-rt9.patch.gz &gt; /dev/null 2&gt;&amp;1  </span>

<span class='c'># tar -jxvf linux-3.14.12.tar.bz2</span>
<span class='c'># mv linux-3.14.12 linux-3.14.12-rt9</span>
<span class='c'># cd linux-3.14.12-rt9</span>
<span class='c'># zcat ../patch-3.14.12-rt9.patch.gz | patch -p1</span>
</code></pre></div>
<p>With the patched kernel setup, we can go configure and test the installation to our leisure. First we need to login to our vagrant box.</p>
<div class='highlight'><pre><code class='bash'>vagrant ssh
</code></pre></div>
<p>Then we perform the kernel setup steps listed below.</p>
<div class='highlight'><pre><code class='bash'><span class='nb'>cd </span>linux-3.14.12-rt9
</code></pre></div><div class='highlight'><pre><code class='bash'><span class='c'># copy over your current kernel config file</span>
cp /boot/config-<span class='sb'>`</span>uname -r<span class='sb'>`</span> .config
</code></pre></div><div class='highlight'><pre><code class='bash'><span class='c'># run menuconfig</span>
<span class='c'># I ran into an issue where I was missing library ncurses</span>
sudo apt-get install libncurses5-dev
make menuconfig 
</code></pre></div>
<p>You should see a text based configuration screen for the kernel. Follow the steps outlined below to install your kernel. Lets go completely preemptable.</p>
<div class='highlight'><pre><code class='text'>Processor type and features  ---&gt;
      Preemption Mode (Complete Preemption (Real-Time))  ---&gt;
</code></pre></div>
<p>You probably want some debugging to see what blows up.</p>
<div class='highlight'><pre><code class='text'>Kernel hacking  ---&gt;
   [*] Tracers  ---&gt;
      --- Tracers
      [*]   Kernel Function Tracer
      [*]   Interrupts-off Latency Tracer
      [*]     Interrupts-off Latency Histogram
      [*]   Preemption-off Latency Traver
      [*]     Preemption-off Latency Histogram
      [*]   Scheduling Latency Tracer
      [*]     Scheduling Latency Histogram
      [*]   Missed timer offsets histogram
   [*] Debug Preemptive Kernel ---&gt;
      --- Locking Debug 
      [*] RT Mutex debugging, deadlock detection
      [*] Built-in scriptable tester for rt-mutexes
      -*- Spinlock and rw-lock debugging: basic checks
      -*- Mutex debugging: basic checks
      [*] Wait/wound mutex debugging: Slowpath testing 
      -*- Lock debugging: detect incorrect freeing of live locks
      [*] Lock debugging: prove locking correctness
      [*] Lock usage statistics
      [*] Lock dependency engine debugging
      [*] Sleep inside atomic section checking
      [*] Locking API boot-time self-tests
</code></pre></div>
<p><img src="https://s3-us-west-2.amazonaws.com/nickma.com/Kernelconfig-2014-07-19+at+12.42.42+PM.png" alt="Config Page" /></p>

<p><img src="https://s3-us-west-2.amazonaws.com/nickma.com/Screen+Shot+2014-07-19+at+1.05.54+PM.png" alt="Preempt RT Flag" /></p>

<p>A note from <a href="https://www.osadl.org/Realtime-Preempt-Kernel.kernel-rt.0.html#ubuntu">www.osadl.com</a>: Should you happen to be the proud owner of a multi-core processor, be sure to specify the -j <code>&lt;jobs</code>&gt; option of make where <code>&lt;jobs</code>&gt; is twice the number of cores your processor has, as this will speed up kernel compilation considerably.</p>
<div class='highlight'><pre><code class='bash'><span class='c'># takes a while to build the things, good time to coffee break</span>
<span class='c'># add the -j if you know how many cores you have.</span>
sudo make

<span class='c'># then we install the built kernel</span>
make modules_install install
</code></pre></div>
<p>At this point you should be able to test out the kernel, perhaps in a later post if I find the bandwidth.</p>

<h3 id="alternative">Alternative</h3>

<p>Near the end of my research I found out that ubuntu has its own linux-realtime that can be apt-get installed, though only for certain versions, you may end up on an older version of the kernel. This is a far simpler solution on <a href="https://wiki.ubuntu.com/RealTime">ubuntu/RealTime</a>.</p>

<p>If you want to try this method, its easy! Since we are on a virtual machine, just kill it off with vagrant destroy and rebuild it with the correct base box. Just replace the provisioning script with the procedures on link above.</p>
					<div class="meta">
						<p class="date-publish">
							Published: 
							<date class="date-pub" title="2014-07-19T00:00:00-07:00" datetime="2014-07-19T00:00:00-07:00" pubdate>
							<span class="month"><abbr>July</abbr></span>
							<span class="day">19</span>
							<span class="year">2014</span>
							</date>
						</p>
						<ul class="list-category list-linear">
							<li class="list-head">category: </li>
							
							


  
     
    	<li><a href="/categories.html#blog-ref">
    		blog <span>1</span>
    	</a></li>
    
  


						</ul>
						<ul class="list-tag list-linear">
							<li class="list-head">tags: </li>
							
							


  
     
    	<li><a href="/tags.html#Vagrant-ref">Vagrant <span>2</span></a></li>
     
    	<li><a href="/tags.html#Ubuntu Kernel-ref">Ubuntu Kernel <span>1</span></a></li>
    
  



						</ul>
					</div><!-- meta -->
				</div><!-- entry-content -->

				<div class="misc-content">	
					


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'nickmablog'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




				</div><!-- misc-content -->
				
			</div><!-- bd -->
			<footer class="unit-foot">
				<div class="unit-inner unit-foot-inner">
					<nav class="pagination">
						<ul>
							
							<li class="prev"><a class="internal" rel="prev"  href="/tutorial/2014/07/02/wordpress-on-dokku-with-vagrant-devo" title="View Wordpress on Dokku with Vagrant Devo.">&laquo; Wordpress on Dokku with Vagrant Devo.</a></li>
							

							

							
						</ul>
					</nav>
					<p class="gotop">
						<a href="#page">Back to Top</a>
					</p>
				</div>
			</footer>

		</div><!-- content -->
	</div><!-- unit-inner -->
</article>


				</div>
			</div><!-- unit-inner -->
		</div><!-- unit-body -->
	</div><!-- body -->
	<footer class="the-footer">
		<div class="unit-foot">
			<div class="unit-inner unit-foot-inner">
				<div class="misc vcard">
					<h4>about</h4>
					<ul>
						<li class="contact"><address><span class="author fn n">Nick Ma</span> - <span class="fn email">{ MY FIRST NAME }@nickma.com</span></address></li>
						<li class="github"><a href="http://github.com/nma/" rel="me">github.com/nma</a></li>
						<li class="twitter"><a href="http://twitter.com/NickMa38/" rel="me">twitter.com/NickMa38</a></li>
						<li class="rss"><a href="http://feeds.feedburner.com/">Subscribe to RSS Feed</a></li>
					</ul>
				</div><!-- misc -->
				<p class="licence">
					Theme: <a href="http://layouts-the.me">the_minimum</a> based on <a href="http://jekyllbootstrap.com/">Jekyll-bootstrap</a>.<br>
					Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a>.
				</p>
			</div><!-- unit-foot-inner -->
		</div><!-- unit-foot -->
	</footer>
</div><!-- page -->
<script>
	(function(d, s) {
		var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.src = url; js.id = id;
		fjs.parentNode.insertBefore(js, fjs);
		};
	load('//platform.twitter.com/widgets.js', 'tweetjs');
	// load('https://apis.google.com/js/plusone.js', 'gplus1js'); // Checkout http://j.mp/ApDgMr for usage html for this is <div class="g-plusone" data-size="medium"></div>
	// load('//connect.facebook.net/en_US/all.js#xfbml=1', 'fbjssdk'); // Checkout http://j.mp/wZw2xR for using open graph protorol html for this is <div class="fb-like" data-href="/blog/2014/07/19/testing-custom-linux-kernels-on-vagrant" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false" data-font="verdana"></div>

    var images = document.getElementsByTagName('img');
    var myImge = null;
    for(var i = 0; i < images.length; ++i) {
      myImage = images[i];
      myImage.onload = function() { 
        if (this.offsetWidth > this.parentNode.offsetWidth) {
          this.style.width = this.parentNode.offsetWidth + "px";
          this.style.height = "100%";
        }
      }
    }

	}(document, 'script'));
</script>
<script>
/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
</script>

  
</body>
</html>

