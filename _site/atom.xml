<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>Nick Ma's Blog</title>
 <link href="http://www.nickma.com/" rel="self"/>
 <link href="http://www.nickma.com"/>
 <updated>2014-07-19T15:13:20-07:00</updated>
 <id>http://www.nickma.com</id>
 <author>
   <name>Nick Ma</name>
   <email>{ MY FIRST NAME }@nickma.com</email>
 </author>

 
 <entry>
   <title>Testing Custom Linux Kernels on Vagrant.</title>
   <link href="http://www.nickma.com/blog/2014/07/19/testing-custom-linux-kernels-on-vagrant"/>
   <updated>2014-07-19T00:00:00-07:00</updated>
   <id>http://www.nickma.com/blog/2014/07/19/testing-custom-linux-kernels-on-vagrant</id>
   <content type="html">&lt;p&gt;A friend was building a custom Ubuntu kernel and after installing the new kernel on the machine the login page refused to work.&lt;/p&gt;

&lt;p&gt;After reading about vagrant and working with virtual machines, I felt that testing major OS changes will definitely be beneficial on a virtual machine. So this blog post details my attempt (vain or not) at making a easily rebootable Vagrant environment to test potentially OS breaking changes to the kernel with out having to constantly re-install the OS on a physical machine.&lt;/p&gt;

&lt;p&gt;The first step will be to setup a default box for Vagrant to work. Since I had previously downloaded a trusty32-amd machine, I will stick with that for my base box.&lt;/p&gt;

&lt;p&gt;Define our Vagrantfile in the project directory should look like this.&lt;/p&gt;

&lt;p&gt;VagrantFile&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='ruby'&gt;&lt;span class='c1'&gt;# -*- mode: ruby -*-&lt;/span&gt;
&lt;span class='c1'&gt;# vi: set ft=ruby :&lt;/span&gt;

&lt;span class='c1'&gt;# Vagrantfile API/syntax version. Don&amp;#39;t touch unless you know what you&amp;#39;re doing!&lt;/span&gt;
&lt;span class='no'&gt;VAGRANTFILE_API_VERSION&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;2&amp;quot;&lt;/span&gt;
&lt;span class='no'&gt;BOX_NAME&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_NAME&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;trusty32-amd&amp;quot;&lt;/span&gt;
&lt;span class='no'&gt;BOX_URI&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_URI&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box&amp;quot;&lt;/span&gt; 
&lt;span class='no'&gt;BOX_MEMORY&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_MEMORY&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='mi'&gt;512&lt;/span&gt;
&lt;span class='no'&gt;BOX_HOST&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_HOST&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;preempt-rt&amp;quot;&lt;/span&gt;

&lt;span class='no'&gt;Vagrant&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;VAGRANTFILE_API_VERSION&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
  &lt;span class='c1'&gt;# All Vagrant configuration is done here. The most common configuration&lt;/span&gt;
  &lt;span class='c1'&gt;# options are documented and commented below. For a complete reference,&lt;/span&gt;
  &lt;span class='c1'&gt;# please see the online documentation at vagrantup.com.&lt;/span&gt;

  &lt;span class='c1'&gt;# Every Vagrant virtual environment requires a box to build off of.&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;box&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;BOX_NAME&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;box_url&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;BOX_URI&lt;/span&gt;

  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;host_name&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;BOX_HOST&lt;/span&gt;

  &lt;span class='c1'&gt;# Disable automatic box update checking. If you disable this, then&lt;/span&gt;
  &lt;span class='c1'&gt;# boxes will only be checked for updates when the user runs&lt;/span&gt;
  &lt;span class='c1'&gt;# `vagrant box outdated`. This is not recommended.&lt;/span&gt;
  &lt;span class='c1'&gt;# config.vm.box_check_update = false&lt;/span&gt;

  &lt;span class='c1'&gt;# Create a forwarded port mapping which allows access to a specific port&lt;/span&gt;
  &lt;span class='c1'&gt;# within the machine from a port on the host machine. In the example below,&lt;/span&gt;
  &lt;span class='c1'&gt;# accessing &amp;quot;localhost:8080&amp;quot; will access port 80 on the guest machine.&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;network&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;forwarded_port&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;guest&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='mi'&gt;80&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;host&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='mi'&gt;8080&lt;/span&gt;

  &lt;span class='c1'&gt;# Create a private network, which allows host-only access to the machine&lt;/span&gt;
  &lt;span class='c1'&gt;# using a specific IP.&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;network&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;private_network&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;ip&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;192.168.33.10&amp;quot;&lt;/span&gt;

  &lt;span class='c1'&gt;# Create a public network, which generally matched to bridged network.&lt;/span&gt;
  &lt;span class='c1'&gt;# Bridged networks make the machine appear as another physical device on&lt;/span&gt;
  &lt;span class='c1'&gt;# your network.&lt;/span&gt;
  &lt;span class='c1'&gt;# config.vm.network &amp;quot;public_network&amp;quot;&lt;/span&gt;

  &lt;span class='c1'&gt;# If true, then any SSH connections made will enable agent forwarding.&lt;/span&gt;
  &lt;span class='c1'&gt;# Default value: false&lt;/span&gt;
  &lt;span class='c1'&gt;# config.ssh.forward_agent = true&lt;/span&gt;

  &lt;span class='c1'&gt;# Share an additional folder to the guest VM. The first argument is&lt;/span&gt;
  &lt;span class='c1'&gt;# the path on the host to the actual folder. The second argument is&lt;/span&gt;
  &lt;span class='c1'&gt;# the path on the guest to mount the folder. And the optional third&lt;/span&gt;
  &lt;span class='c1'&gt;# argument is a set of non-required options.&lt;/span&gt;
  &lt;span class='c1'&gt;# config.vm.synced_folder &amp;quot;../data&amp;quot;, &amp;quot;/vagrant_data&amp;quot;&lt;/span&gt;

  &lt;span class='c1'&gt;# Provider-specific configuration so you can fine-tune various&lt;/span&gt;
  &lt;span class='c1'&gt;# backing providers for Vagrant. These expose provider-specific options.&lt;/span&gt;
  &lt;span class='c1'&gt;# Example for VirtualBox:&lt;/span&gt;
  &lt;span class='c1'&gt;#&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;provider&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;virtualbox&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;vb&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
    &lt;span class='c1'&gt;# Don&amp;#39;t boot with headless mode&lt;/span&gt;
    &lt;span class='c1'&gt;# vb.gui = true&lt;/span&gt;

    &lt;span class='c1'&gt;# Use VBoxManage to customize the VM. For example to change memory:&lt;/span&gt;
    &lt;span class='n'&gt;vb&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;customize&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;modifyvm&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;--memory&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='no'&gt;BOX_MEMORY&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;

    &lt;span class='c1'&gt;# Allow vm to directly access the hosts pci hardware&lt;/span&gt;
    &lt;span class='c1'&gt;# https://www.virtualbox.org/manual/ch09.html#pcipassthrough&lt;/span&gt;
    &lt;span class='c1'&gt;# vb.customize [&amp;quot;modifyvm&amp;quot;, :id, &amp;quot;--pciattach&amp;quot;, &amp;lt;CPU-architecture supported id.&amp;gt;]&lt;/span&gt;

  &lt;span class='k'&gt;end&lt;/span&gt;
  
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;provision&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;shell&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;path&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;get-linux-kernel.sh&amp;quot;&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After defining our Vagrantfile, we setup a shell provisioner to automate our installation of our system.&lt;/p&gt;

&lt;p&gt;get-linux-kernel.sh&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='c'&gt;#!/bin/bash&lt;/span&gt;

&lt;span class='c'&gt;# locate our most up to date preempt_rt kernel patch, default to 3.14 if not set&lt;/span&gt;
&lt;span class='nv'&gt;PREEMPT_RT_VERSION&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;PREEMPT_RT_VERSION&lt;/span&gt;&lt;span class='k'&gt;:-&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;3.14.12-rt9&amp;quot;&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt;
&lt;span class='c'&gt;# the linux kernel must match the patch version.&lt;/span&gt;
&lt;span class='nv'&gt;LINUX_KERNEL_VERSION&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;PREEMPT_RT_VERSION&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt;
&lt;span class='c'&gt;# to ensure our kernel does not contain any malware, we grab the signer&amp;#39;s public key &lt;/span&gt;
&lt;span class='nv'&gt;KERNEL_GPG_KEY&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;KERNEL_GPG_KEY&lt;/span&gt;&lt;span class='k'&gt;:-&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;00411886&amp;quot;&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt;

&lt;span class='nb'&gt;echo&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;GET KERNAL VERSION --&amp;gt; ${PREEMPT_RT_VERSION}&amp;quot;&lt;/span&gt;

&lt;span class='c'&gt;# install linux kernel manager ketchup&lt;/span&gt;
&lt;span class='nb'&gt;echo&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Attempting to install ketchup kernel manager.&amp;quot;&lt;/span&gt;
sudo apt-get install ketchup
&lt;span class='nb'&gt;cd&lt;/span&gt; /usr/src/kernels
mkdir linux
&lt;span class='nb'&gt;cd &lt;/span&gt;linux

&lt;span class='c'&gt;# setup our loading key&lt;/span&gt;
gpg --recv-keys &lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;KERNEL_GPG_KEY&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt;

&lt;span class='c'&gt;# grab the kernel source &lt;/span&gt;
&lt;span class='nb'&gt;echo&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Grabbing kernel version ${LINUX_KERNEL_VERSION}... (may take a while to grab source files)&amp;quot;&lt;/span&gt;
ketchup -r -G &lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;PREEMPT_RT_VERSION&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt; &amp;gt; /dev/null 2&amp;gt;&lt;span class='p'&gt;&amp;amp;&lt;/span&gt;1
&lt;span class='nb'&gt;echo&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;Completed linux kernel source download. Now you can go configure it.&amp;quot;&lt;/span&gt;

&lt;span class='c'&gt;# NOTE: ketchup command above just automating this process below...&lt;/span&gt;

&lt;span class='c'&gt;# get and apply the preempt-rt patch&lt;/span&gt;
&lt;span class='c'&gt;# wget http://www.kernel.org/pub/linux/kernel/v3.14/linux-3.14.12.tar.bz2 &amp;gt; /dev/null 2&amp;gt;&amp;amp;1 &lt;/span&gt;
&lt;span class='c'&gt;# wget https://www.kernel.org/pub/linux/kernel/projects/rt/3.14/patch-3.14.12-rt9.patch.gz &amp;gt; /dev/null 2&amp;gt;&amp;amp;1  &lt;/span&gt;

&lt;span class='c'&gt;# tar -jxvf linux-3.14.12.tar.bz2&lt;/span&gt;
&lt;span class='c'&gt;# mv linux-3.14.12 linux-3.14.12-rt9&lt;/span&gt;
&lt;span class='c'&gt;# cd linux-3.14.12-rt9&lt;/span&gt;
&lt;span class='c'&gt;# zcat ../patch-3.14.12-rt9.patch.gz | patch -p1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With the patched kernel setup, we can go configure and test the installation to our leisure. First we need to login to our vagrant box.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;vagrant ssh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then we perform the kernel setup steps listed below.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nb'&gt;cd &lt;/span&gt;linux-3.14.12-rt9
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='c'&gt;# copy over your current kernel config file&lt;/span&gt;
cp /boot/config-&lt;span class='sb'&gt;`&lt;/span&gt;uname -r&lt;span class='sb'&gt;`&lt;/span&gt; .config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='c'&gt;# run menuconfig&lt;/span&gt;
&lt;span class='c'&gt;# I ran into an issue where I was missing library ncurses&lt;/span&gt;
sudo apt-get install libncurses5-dev
make menuconfig 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see a text based configuration screen for the kernel. Follow the steps outlined below to install your kernel. Lets go completely preemptable.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;Processor type and features  ---&amp;gt;
      Preemption Mode (Complete Preemption (Real-Time))  ---&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You probably want some debugging to see what blows up.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;Kernel hacking  ---&amp;gt;
   [*] Tracers  ---&amp;gt;
      --- Tracers
      [*]   Kernel Function Tracer
      [*]   Interrupts-off Latency Tracer
      [*]     Interrupts-off Latency Histogram
      [*]   Preemption-off Latency Traver
      [*]     Preemption-off Latency Histogram
      [*]   Scheduling Latency Tracer
      [*]     Scheduling Latency Histogram
      [*]   Missed timer offsets histogram
   [*] Debug Preemptive Kernel ---&amp;gt;
      --- Locking Debug 
      [*] RT Mutex debugging, deadlock detection
      [*] Built-in scriptable tester for rt-mutexes
      -*- Spinlock and rw-lock debugging: basic checks
      -*- Mutex debugging: basic checks
      [*] Wait/wound mutex debugging: Slowpath testing 
      -*- Lock debugging: detect incorrect freeing of live locks
      [*] Lock debugging: prove locking correctness
      [*] Lock usage statistics
      [*] Lock dependency engine debugging
      [*] Sleep inside atomic section checking
      [*] Locking API boot-time self-tests
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://s3-us-west-2.amazonaws.com/nickma.com/Kernelconfig-2014-07-19+at+12.42.42+PM.png&quot; alt=&quot;Config Page&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://s3-us-west-2.amazonaws.com/nickma.com/Screen+Shot+2014-07-19+at+1.05.54+PM.png&quot; alt=&quot;Preempt RT Flag&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A note from &lt;a href=&quot;https://www.osadl.org/Realtime-Preempt-Kernel.kernel-rt.0.html#ubuntu&quot;&gt;www.osadl.com&lt;/a&gt;: Should you happen to be the proud owner of a multi-core processor, be sure to specify the -j &lt;code&gt;&amp;lt;jobs&lt;/code&gt;&amp;gt; option of make where &lt;code&gt;&amp;lt;jobs&lt;/code&gt;&amp;gt; is twice the number of cores your processor has, as this will speed up kernel compilation considerably.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='c'&gt;# takes a while to build the things, good time to coffee break&lt;/span&gt;
&lt;span class='c'&gt;# add the -j if you know how many cores you have.&lt;/span&gt;
sudo make

&lt;span class='c'&gt;# then we install the built kernel&lt;/span&gt;
make modules_install install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;At this point you should be able to test out the kernel, perhaps in a later post if I find the bandwidth.&lt;/p&gt;

&lt;h3 id=&quot;alternative&quot;&gt;Alternative&lt;/h3&gt;

&lt;p&gt;Near the end of my research I found out that ubuntu has its own linux-realtime that can be apt-get installed, though only for certain versions, you may end up on an older version of the kernel. This is a far simpler solution on &lt;a href=&quot;https://wiki.ubuntu.com/RealTime&quot;&gt;ubuntu/RealTime&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If you want to try this method, its easy! Since we are on a virtual machine, just kill it off with vagrant destroy and rebuild it with the correct base box. Just replace the provisioning script with the procedures on link above.&lt;/p&gt;</content>
 </entry>
 
 <entry>
   <title>Wordpress on Dokku with Vagrant Devo.</title>
   <link href="http://www.nickma.com/tutorial/2014/07/02/wordpress-on-dokku-with-vagrant-devo"/>
   <updated>2014-07-02T00:00:00-07:00</updated>
   <id>http://www.nickma.com/tutorial/2014/07/02/wordpress-on-dokku-with-vagrant-devo</id>
   <content type="html">&lt;p&gt;For a new project I am taking on, I wanted to have my own Platform as a Service (PaaS) that has a git push deploy hook like Heroku. There are a few open source projects out there that are currently trying to replicate Heroku, such as &lt;a href=&quot;https://github.com/flynn/flynn&quot;&gt;Flynn&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Flynn is trying to become an open source Heroku replacement, but it has too many features that are overkill for our simple applications. I only want the git push deploy for now, this is where &lt;a href=&quot;https://github.com/progrium/dokku&quot;&gt;Dokku&lt;/a&gt; comes in.&lt;/p&gt;

&lt;p&gt;Dokku is a very hackable and has very small code base, making it much easier to understand. I plan to use Vagrant to setup a local Dokku instance.&lt;/p&gt;

&lt;p&gt;To start a development environment I choose to use Vagrant, which is a tool that wraps development environments inside a virtual machine using VirtualBox, VMware, and AWS, and etc. (Full list on the official Vagrant docs). After a few attempts fiddling with my own opts and constantly being hit with . The first step is to install Vagrant and the virtual machine provider (VirtualBox in my case), the installation will vary, so make sure to check the Vagrant docs for your platform.&lt;/p&gt;

&lt;p&gt;I am currently reading the book &lt;a href=&quot;http://www.amazon.com/gp/product/1449335837/ref=as_li_tl?ie=UTF8&amp;amp;camp=1789&amp;amp;creative=390957&amp;amp;creativeASIN=1449335837&amp;amp;linkCode=as2&amp;amp;tag=nisbl00c-20&amp;amp;linkId=E3QWJ4CWFM7XNHFW&quot;&gt;Vagrant: Up and Running&lt;/a&gt; to learn Vagrant as I go along. This is a pretty detailed book written by the author of Vagrant, it contains all the details you need to start using Vagrant properly. If bedside reading is not your thing, don’t worry, this tutorial provides a Vagrant configuration so you don’t need to touch anything.&lt;/p&gt;

&lt;h3 id=&quot;what_you_need&quot;&gt;What You Need&lt;/h3&gt;

&lt;p&gt;Before we begin our tutorial, please make sure you have the following installed:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.vagrantup.com/&quot;&gt;Vagrant&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href=&quot;https://www.virtualbox.org/&quot;&gt;Virtualbox&lt;/a&gt; (or any other provider supported by Vagrant)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can go on their official webpages for most troubleshooting information.&lt;/p&gt;

&lt;h3 id=&quot;vagrant_developement_setup&quot;&gt;Vagrant Developement Setup&lt;/h3&gt;

&lt;p&gt;We first get our working folder setup, then setup our Vagrant.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;git clone https://github.com/mhoofman/wordpress-heroku wp-app
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;&lt;span class='nb'&gt;cd &lt;/span&gt;wp-app
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Following up, we setup our devo environment.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;vagrant init
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should now see a file called &lt;a href=&quot;https://docs.vagrantup.com/v2/vagrantfile/index.html&quot;&gt;Vagrantfile&lt;/a&gt; in your project directory. Which is a configuration file for launching and provisioning VMs. Next we will use the following configuration to setup our devo environment.&lt;/p&gt;

&lt;p&gt;The following configuration file is modified from the Dokku project repo, which will allow us to configure our virtual machine.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='ruby'&gt;&lt;span class='no'&gt;VAGRANTFILE_API_VERSION&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;2&amp;quot;&lt;/span&gt;

&lt;span class='c1'&gt;# locate requisite ENV variables or default&lt;/span&gt;
&lt;span class='no'&gt;BOX_NAME&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_NAME&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;trusty32&amp;quot;&lt;/span&gt;
&lt;span class='no'&gt;BOX_URI&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_URI&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box&amp;quot;&lt;/span&gt; 
&lt;span class='no'&gt;BOX_MEMORY&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;BOX_MEMORY&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;512&amp;quot;&lt;/span&gt;
&lt;span class='no'&gt;DOKKU_DOMAIN&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;DOKKU_DOMAIN&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;dokku.me&amp;quot;&lt;/span&gt;
&lt;span class='no'&gt;DOKKU_IP&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;ENV&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;DOKKU_IP&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt; &lt;span class='o'&gt;||&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;10.0.0.2&amp;quot;&lt;/span&gt;

&lt;span class='no'&gt;Vagrant&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;configure&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='no'&gt;VAGRANTFILE_API_VERSION&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
  &lt;span class='c1'&gt;# define the vm box we need to use to config dokku&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;box&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;BOX_NAME&lt;/span&gt;
  
  &lt;span class='c1'&gt;# tell vagrant where to find the box if it can&amp;#39;t locate it by the name&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;box_url&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='no'&gt;BOX_URI&lt;/span&gt;

  &lt;span class='c1'&gt;# tells vagrant to sync this folder with /root/dokku/ on the virtual machine &lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;synced_folder&lt;/span&gt; &lt;span class='no'&gt;File&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;dirname&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='bp'&gt;__FILE__&lt;/span&gt;&lt;span class='p'&gt;),&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;/root/dokku&amp;quot;&lt;/span&gt;

  &lt;span class='c1'&gt;# configure the vm to forward its 80 port to 8080&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;network&lt;/span&gt; &lt;span class='ss'&gt;:forwarded_port&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;guest&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='mi'&gt;80&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;host&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='mi'&gt;8080&lt;/span&gt;

  &lt;span class='c1'&gt;# configure the vm&amp;#39;s name&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;hostname&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='si'&gt;#{&lt;/span&gt;&lt;span class='no'&gt;DOKKU_DOMAIN&lt;/span&gt;&lt;span class='si'&gt;}&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;

  &lt;span class='c1'&gt;# From Vagrant doc&amp;#39;s: &lt;/span&gt;
  &lt;span class='c1'&gt;# Private networks allow you to access your guest machine only from your own machine &lt;/span&gt;
  &lt;span class='c1'&gt;# disallows public accessible, specify ip to your DOKKU_IP&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;network&lt;/span&gt; &lt;span class='ss'&gt;:private_network&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;ip&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt; &lt;span class='no'&gt;DOKKU_IP&lt;/span&gt;

  &lt;span class='c1'&gt;# tell vagrant to use virtualbox for our purposes, &lt;/span&gt;
  &lt;span class='c1'&gt;# we can have multiple provider blocks for as many providers as we need.&lt;/span&gt;
  &lt;span class='n'&gt;config&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;vm&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;provider&lt;/span&gt; &lt;span class='ss'&gt;:virtualbox&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt; &lt;span class='o'&gt;|&lt;/span&gt;&lt;span class='n'&gt;vb&lt;/span&gt;&lt;span class='o'&gt;|&lt;/span&gt;
    &lt;span class='c1'&gt;# this option makes the NAT engine use the host&amp;#39;s resolver mechanisms to handle DNS requests &lt;/span&gt;
    &lt;span class='c1'&gt;# which essentially means that we can specify domain &amp;quot;dokku.me&amp;quot; to be resolved by our local hosts file &lt;/span&gt;
    &lt;span class='n'&gt;vb&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;customize&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;modifyvm&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;--natdnshostresolver1&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;on&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;
    &lt;span class='c1'&gt;# set the memory of the virtualbox&lt;/span&gt;
    &lt;span class='n'&gt;vb&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='n'&gt;customize&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;modifyvm&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='ss'&gt;:id&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;--memory&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='no'&gt;BOX_MEMORY&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;
  &lt;span class='k'&gt;end&lt;/span&gt;
  
  &lt;span class='c1'&gt;# no vagrant provisioning because we setup Dokku and let it provision our wp-app for us.&lt;/span&gt;
  &lt;span class='c1'&gt;# install Dokku on the vagrant vm with bootstrap.sh.&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we create a bash script to bootstrap our Vagrant machine. Using a script creates a deterministic provisioning process to avoid future headaches. Create a file called bootstrap.sh with the following contents.&lt;/p&gt;

&lt;p&gt;bootstrap.sh&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='c'&gt;#!/bin/bash&lt;/span&gt;

&lt;span class='c'&gt;# reference of bootstrap.sh of https://github.com/RyanBalfanz/dokku-vagrant-example&lt;/span&gt;

&lt;span class='c'&gt;# add our envs&lt;/span&gt;
&lt;span class='nv'&gt;DB_PLUGIN&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;postgresql

&lt;span class='c'&gt;# setup the vmachine if it hasn&amp;#39;t been done already&lt;/span&gt;
vagrant up

&lt;span class='c'&gt;# run commands to build Dokku on our vagrant box&lt;/span&gt;
&lt;span class='c'&gt;# vagrant ssh will automagtocally open up an interactive terminal to our vm.&lt;/span&gt;
&lt;span class='c'&gt;# the &amp;#39;--&amp;#39; means the end of a command, so vagrant ssh will not take any more arguments.&lt;/span&gt;
&lt;span class='c'&gt;# once we vagrant ssh, we install Dokku (commands from the Dokku github page).&lt;/span&gt;
vagrant ssh -- &lt;span class='s2'&gt;&amp;quot;wget -qO- https://raw.github.com/progrium/dokku/v0.2.3/bootstrap.sh | sudo DOKKU_TAG=v0.2.3 bash&amp;quot;&lt;/span&gt;

&lt;span class='c'&gt;# run commands to install our Dokku postgresql plugin &lt;/span&gt;
&lt;span class='nv'&gt;PLUGIN_FOUND&lt;/span&gt;&lt;span class='o'&gt;=&lt;/span&gt;&lt;span class='sb'&gt;`&lt;/span&gt;vagrant ssh -- &lt;span class='s2'&gt;&amp;quot;test -d /var/lib/dokku/plugins/${DB_PLUGIN} &amp;amp;&amp;amp; echo 0 || echo 1&amp;quot;&lt;/span&gt;&lt;span class='sb'&gt;`&lt;/span&gt;
&lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='o'&gt;[&lt;/span&gt; &lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;PLUGIN_FOUND&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt; -eq 0 &lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;;&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
&lt;span class='k'&gt;    &lt;/span&gt;&lt;span class='nb'&gt;echo&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;${DB_PLUGIN} plugin found! Skipping installation.&amp;quot;&lt;/span&gt; 
&lt;span class='k'&gt;else&lt;/span&gt;
&lt;span class='k'&gt;    &lt;/span&gt;&lt;span class='nb'&gt;echo&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;${DB_PLUGIN} plugin does not exist! Installing...&amp;quot;&lt;/span&gt;
    &lt;span class='c'&gt;# install ${DB_PLUGIN} plugin on our Dokku, commands from the plugin github page.&lt;/span&gt;
    vagrant ssh -- &lt;span class='s2'&gt;&amp;quot;cd /var/lib/dokku/plugins &amp;amp;&amp;amp; sudo git clone https://github.com/Kloadut/dokku-pg-plugin ${DB_PLUGIN} &amp;amp;&amp;amp; sudo dokku plugins-install&amp;quot;&lt;/span&gt;
&lt;span class='k'&gt;fi&lt;/span&gt;

&lt;span class='c'&gt;# pass our public key to the dokku machine, this allows us to git push deploy&lt;/span&gt;
cat ~/.ssh/id_rsa.pub &lt;span class='p'&gt;|&lt;/span&gt; vagrant ssh -- sudo sshcommand acl-add dokku &lt;span class='k'&gt;${&lt;/span&gt;&lt;span class='nv'&gt;USER&lt;/span&gt;&lt;span class='k'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;At this point your file structure should look like this.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ ls 
   |- .git
   |- .htaccess
   |- .vagrant
   |- README.md
   |- Vagrantfile  &amp;lt;-- 
   |- bootstrap.sh &amp;lt;-- 
   |- index.php
   |- ... etc wp files ...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we make bootstrap.sh executable and run it.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ chmod +x bootstrap.sh
$ ./bootstrap.sh
$ ... etc Vagrant output ... 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It will take a while for the bootstrapper to install and configure vagrant.&lt;/p&gt;

&lt;p&gt;So I highly recommend you go view a &lt;a href=&quot;http://progrium.com/blog/2013/06/19/dokku-the-smallest-paas-implementation-youve-ever-seen/&quot;&gt;video on how Dokku works&lt;/a&gt; by the creator. By the time you finish checking out the video your vagrant vm should be provisioned and you should be ready to push to your devo.&lt;/p&gt;

&lt;h3 id=&quot;preparing_to_deploy_to_devo&quot;&gt;Preparing to Deploy to Devo&lt;/h3&gt;

&lt;p&gt;Since we have set our Vagrant config to resolve domains to our native hosts file, we define a few host entries in /etc/hosts.&lt;/p&gt;

&lt;p&gt;/etc/hosts&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;# for local dokku deploy
10.0.0.2    dokku.me
10.0.0.2    wp-app.dokku.me
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, we prepare to deploy our app.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ git remote add devo dokku@dokku.me:wp-app
$ git push devo master 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;Counting objects: 5127, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (2643/2643), done.
Writing objects: 100% (5127/5127), 15.12 MiB | 17.37 MiB/s, done.
Total 5127 (delta 2403), reused 5114 (delta 2395)
-----&amp;gt; Cleaning up ...
remote: Cloning into &amp;#39;/tmp/tmp.QbyOZK2Zde&amp;#39;...
-----&amp;gt; Building wp-app ...
remote: warning: You appear to have cloned an empty repository.
remote: done.
remote: HEAD is now at 2b0ea36... copied over dokku devo vagrantfile.
       PHP (classic) app detected
-----&amp;gt; Bundling NGINX 1.4.4
-----&amp;gt; Bundling PHP 5.5.9
-----&amp;gt; Bundling extensions
       apcu
       phpredis
       mongo
-----&amp;gt; Setting up default configuration
-----&amp;gt; Vendoring binaries into slug
-----&amp;gt; Discovering process types
       Default process types for PHP (classic) -&amp;gt; web
-----&amp;gt; Releasing wp-app ...
-----&amp;gt; Deploying wp-app ...
=====&amp;gt; Application deployed:
       http://wp-app.dokku.me

To dokku@dokku.me:wp-app
 * [new branch]      master -&amp;gt; master 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;setting_up_our_database&quot;&gt;Setting Up Our Database&lt;/h4&gt;

&lt;p&gt;Before we proceed to test our instance we want a database, so we run some Dokku postgresql commands to create one.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ ssh dokku@dokku.me postgresql:create wp-app
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;-----&amp;gt; Creating /home/dokku/wp-app/ENV
-----&amp;gt; Setting config vars and restarting wp-app
DATABASE_URL: postgres://root:ZwCRrphjiQYJ1Pvx@172.17.42.1:49154/db
-----&amp;gt; Releasing wp-app ...
-----&amp;gt; Release complete!
-----&amp;gt; Deploying wp-app ...
-----&amp;gt; Checking status of PostgreSQL
       Found image postgresql/wp-app database
       Checking status... ok.
-----&amp;gt; Deploy complete!

-----&amp;gt; wp-app linked to postgresql/wp-app database

-----&amp;gt; PostgreSQL container created: postgresql/wp-app

       Host: 172.17.42.1
       Port: 49154
       User: &amp;#39;root&amp;#39;
       Password: &amp;#39;ZwCRrphjiQYJ1Pvx&amp;#39;
       Database: &amp;#39;db&amp;#39;

       Url: &amp;#39;postgres://root:ZwCRrphjiQYJ1Pvx@172.17.42.1:49154/db&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note: Docs for plugin we used for this tutorial can be found here &lt;a href=&quot;https://github.com/Kloadut/dokku-pg-plugin&quot;&gt;Kloadut/dokku-pg-plugin&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Then update Dokku with the environment variable.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ ssh dokku@dokku.me postgresql:link wp-app wp-app 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;-----&amp;gt; Setting config vars and restarting wp-app
DATABASE_URL: postgres://root:ZwCRrphjiQYJ1Pvx@172.17.42.1:49154/db 
-----&amp;gt; Releasing wp-app ...
-----&amp;gt; Release complete!
-----&amp;gt; Deploying wp-app ...
-----&amp;gt; Checking status of PostgreSQL
       Found image postgresql/wp-app database
       Checking status... ok.
-----&amp;gt; Deploy complete!

-----&amp;gt; wp-app linked to postgresql/wp-app database
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then do the same for the application environment variables.&lt;/p&gt;

&lt;h4 id=&quot;setup_application_environment_variables&quot;&gt;Setup Application Environment Variables&lt;/h4&gt;

&lt;p&gt;Store unique keys and salts in Dokku environment variables. Wordpress can provide random values &lt;a href=&quot;https://api.wordpress.org/secret-key/1.1/salt/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;# You can upload all the variables with one config:set command, but I broke them out for clarity.
# Due to the way Dokku parses config:set key, value pairs, make sure you wrap the values in escaped quotes (\&amp;#39;&amp;#39;&amp;lt;your value here.
#&amp;gt;&amp;#39;\&amp;#39;) e.g. AUTH_KEY=&amp;#39;&amp;lt;your key&amp;gt;&amp;#39; should be AUTH_KEY=\&amp;#39;&amp;#39;&amp;lt;your key&amp;gt;&amp;#39;\&amp;#39;. 

ssh dokku@dokku.me config:set wp-app AUTH_KEY=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app SECURE_AUTH_KEY=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app LOGGED_IN_KEY=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app NONCE_KEY=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app AUTH_SALT=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app SECURE_AUTH_SALT=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app LOGGED_IN_SALT=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
ssh dokku@dokku.me config:set wp-app NONCE_SALT=\&amp;#39;&amp;#39;&amp;lt;your value here&amp;gt;&amp;#39;\&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;One thing we need to do before the database will connect is to edit wp-config.php to accept a port parameter for our psql.&lt;/p&gt;

&lt;p&gt;wp-config.php&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='php'&gt;&lt;span class='cp'&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class='c1'&gt;// ** Heroku Postgres settings - from Heroku Environment ** //&lt;/span&gt;
&lt;span class='nv'&gt;$db&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;parse_url&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nv'&gt;$_ENV&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;DATABASE_URL&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;]);&lt;/span&gt;

&lt;span class='c1'&gt;// ** MySQL settings - You can get this info from your web host ** //&lt;/span&gt;
&lt;span class='sd'&gt;/** The name of the database for WordPress */&lt;/span&gt;
&lt;span class='nb'&gt;define&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;DB_NAME&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nx'&gt;trim&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nv'&gt;$db&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;path&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;],&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;));&lt;/span&gt;

&lt;span class='sd'&gt;/** MySQL database username */&lt;/span&gt;
&lt;span class='nb'&gt;define&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;DB_USER&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nv'&gt;$db&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;user&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;]);&lt;/span&gt;

&lt;span class='sd'&gt;/** MySQL database password */&lt;/span&gt;
&lt;span class='nb'&gt;define&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;DB_PASSWORD&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nv'&gt;$db&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;pass&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;]);&lt;/span&gt;

&lt;span class='sd'&gt;/** MySQL hostname */&lt;/span&gt;
&lt;span class='nb'&gt;define&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;DB_HOST&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nv'&gt;$db&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;host&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;:&amp;quot;&lt;/span&gt;&lt;span class='o'&gt;.&lt;/span&gt;&lt;span class='nv'&gt;$db&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;port&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;]);&lt;/span&gt;  &lt;span class='c1'&gt;// &amp;lt;---- add .&amp;quot;:&amp;quot;.$db[&amp;quot;port&amp;quot;]&lt;/span&gt;

&lt;span class='o'&gt;...&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Update the changes in a new branch.&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ git checkout -b wp-app-devo
$ git add wp-config.php
$ git commit -m &amp;quot;added db port to wp-config.php&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='text'&gt;$ git push devo wp-app-devo:master
---&amp;gt; app updates...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you should have a working local environment for you wordpress application to run.&lt;/p&gt;

&lt;p&gt;Test it out at &lt;a href=&quot;http://wp-app.dokku.me&quot;&gt;http://wp-app.dokku.me&lt;/a&gt;. Yata!&lt;/p&gt;

&lt;h3 id=&quot;production_setup_bonus&quot;&gt;Production Setup (Bonus)&lt;/h3&gt;

&lt;p&gt;This post mainly focuses on how to use Vagrant to setup a manageable Dokku developement stack. It is recommended that you play with the local stack to get a feel for how Dokku works before committing to a production stack. This section will just be a quickstart guide for production environments, so I assume you have working knowledge of git and setting up a VPS with a Dokku installation.&lt;/p&gt;

&lt;p&gt;The easiest way to get a Dokku host is by following a &lt;a href=&quot;https://www.digitalocean.com/community/tutorials/how-to-use-the-dokku-one-click-digitalocean-image-to-run-a-node-js-app&quot;&gt;1-click setup on digitalocean&lt;/a&gt;. You can also setup Dokku on any server with root access, just follow the instructions listed on the installation readme on &lt;a href=&quot;https://github.com/progrium/dokku&quot;&gt;Dokku&lt;/a&gt;. The steps to setup a working application should be the same.&lt;/p&gt;</content>
 </entry>
 
 
</feed>