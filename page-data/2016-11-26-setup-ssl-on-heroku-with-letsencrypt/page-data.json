{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016-11-26-setup-ssl-on-heroku-with-letsencrypt/","result":{"data":{"site":{"siteMetadata":{"title":"Blog","author":"Nick Ma"}},"markdownRemark":{"id":"4c45abdc-2823-5323-a74c-35cb4d500eb0","excerpt":"So this weekend I had some time to help out on a opensource project manage by some awesome Toronto folks. Task breakdown as follows. The steps are as follows…","html":"<p>So this weekend I had some time to help out on a opensource project manage by some awesome Toronto folks.</p>\n<p>Task breakdown as follows.</p>\n<p>The steps are as follows:</p>\n<ul>\n<li>figure out how to setup the app for SSL or enforce SSL.</li>\n<li>how to test it properly without downtime? because SSL is tied to a domain this mean the quickest way to test is on production.</li>\n<li>figure out how heroku SSL solutions.</li>\n</ul>\n<h2>Enforce SSL and Testing</h2>\n<p>In Rails the way that SSL is enforced is set in a config file, this would be the following path <code class=\"language-text\">config/environments/production.rb</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nconfig<span class=\"token punctuation\">.</span>force_ssl <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token comment\"># This is required or the host server will send headers telling us its from the *.herokuapp.com domain</span>\n<span class=\"token comment\"># subsequently, this will cause the SSL certs registered for our private DNS address to fail.</span>\nconfig<span class=\"token punctuation\">.</span>action_controller<span class=\"token punctuation\">.</span>default_url_options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> host<span class=\"token punctuation\">:</span> <span class=\"token string\">\"www.example.org\"</span> <span class=\"token punctuation\">}</span>\nconfig<span class=\"token punctuation\">.</span>action_controller<span class=\"token punctuation\">.</span>asset_host <span class=\"token operator\">=</span> <span class=\"token string\">\"www.example.org\"</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>By default SSL is an optional protocol to the webapp, a user can direct to <code class=\"language-text\">http://</code> or <code class=\"language-text\">https://</code>, but websites also need a DNS change to redirect <code class=\"language-text\">http://</code> -> <code class=\"language-text\">https://</code>.\nFor most servers we also need to enable the endpoint/port, because regular web traffic routes on <code class=\"language-text\">:80</code>, but https requires <code class=\"language-text\">:443</code> by convention. Rails will perform the redirect when <em>force</em>ssl_ is set to true.</p>\n<blockquote>\n<p>In Heroku… An alternative SSL implementation is available via the SSL Endpoint add-on. The SSL Endpoint add-on is only recommended if you need to support legacy browser clients which do not support SNI. It also costs another $20/mo to enable.</p>\n</blockquote>\n<p>Since most of this projects users won’t be using legacy browsers, we drop the clunky SSL Endpoint and go with the SNI version. Much faster and friendlier!\nDon’t worry too much about the distinction, but if you must here is a <a href=\"https://en.wikipedia.org/wiki/Server_Name_Indication\">wiki link</a>.</p>\n<p>Now to allow this functionality Heroku requests that you direct your app’s DNS to a specific DNS name, which then resolves your application server so that it hits your server with an internal IP.\nWhen you just hit the app at <code class=\"language-text\">example.heroku.com</code>, you are hitting the app at the top level heroku DNS router.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$&gt; heroku domains\n=== example Heroku Domain\nexample.herokuapp.com\n\n=== example Custom Domains\nDomain Name       DNS Target\n────────────────  ──────────────────────────────\nexample.me      example.me.herokudns.com\nwww.example.me  www.example.me.herokudns.com</code></pre></div>\n<p>This is required or the host server will route from *.herokuapp.com domain subsequently, this will cause the SSL certs registered for our private DNS address to fail.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> dig www.example.org\n\n ; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.if-me.org\n ;; global options: +cmd\n ;; Got answer:\n ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERYundefined status: NOERRORundefined id: 23689\n ;; flags: qr rd ra; QUERY: 1undefined ANSWER: 3undefined AUTHORITY: 4undefined ADDITIONAL: 1\n\n ;; OPT PSEUDOSECTION:\n ; EDNS: version: 0undefined flags:; udp: 1280\n ;; QUESTION SECTION:\n ;www.example.org.            IN  A\n\n ;; ANSWER SECTION:\n www.example.org.     1800    IN  CNAME   example.herokuapp.com.\n example.herokuapp.com.    300 IN  CNAME   us-east-1-a.route.herokuapp.com.\n us-east-1-a.route.herokuapp.com. 50 IN A   1.2.188.105\n\n ;; AUTHORITY SECTION:\n herokuapp.com.     400 IN  NS  ns-505.awsdns-63.com.\n herokuapp.com.     400 IN  NS  ns-662.awsdns-18.net.\n herokuapp.com.     400 IN  NS  ns-1378.awsdns-44.org.\n herokuapp.com.     400 IN  NS  ns-1624.awsdns-11.co.uk.\n\n ;; Query time: 218 msec\n ;; SERVER: 127.0.1.1#53(127.0.1.1)\n ;; WHEN: Sun Nov 27 00:52:12 EST 2016\n ;; MSG SIZE  rcvd: 256</code></pre></div>\n<p>When your ANSWER SECTION is a CNAME redirect to example.herokuapp.com, the DNS server tells the browser that this is *.herokuapp.com.\nSince your SSL is registered for www.example.com and not *.herokuapp.com!</p>\n<p>You need to change your DNS to point to the topmost DNS resolver as output by your <code class=\"language-text\">heroku domains</code> command.\nThen your DNS resolution will now return the correct www.example.com metadata for the SSL Cert to be validated.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.example.org\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERYundefined status: NOERRORundefined id: 43572\n;; flags: qr rd ra; QUERY: 1undefined ANSWER: 9undefined AUTHORITY: 4undefined ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0undefined flags:; udp: 1280\n;; QUESTION SECTION:\n;www.example.org.      IN  A\n\n;; ANSWER SECTION:\nwww.example.org.   1800    IN  CNAME   www.example.org.herokudns.com.\nwww.example.org.herokudns.com. 60 IN   A   54.243.119.83\nwww.example.org.herokudns.com. 60 IN   A   54.243.91.166\nwww.example.org.herokudns.com. 60 IN   A   54.561.252.234\nwww.example.org.herokudns.com. 60 IN   A   50.19.93.247\nwww.example.org.herokudns.com. 60 IN   A   54.565.193.561\nwww.example.org.herokudns.com. 60 IN   A   54.565.563.184\nwww.example.org.herokudns.com. 60 IN   A   54.235.135.158\nwww.example.org.herokudns.com. 60 IN   A   54.235.212.238\n\n;; AUTHORITY SECTION:\nherokudns.com.      123094  IN  NS  ns-44.awsdns-05.com.\nherokudns.com.      123094  IN  NS  ns-955.awsdns-55.net.\nherokudns.com.      123094  IN  NS  ns-1260.awsdns-29.org.\nherokudns.com.      123094  IN  NS  ns-1672.awsdns-17.co.uk.\n\n;; Query time: 69 msec\n;; SERVER: 127.0.1.1#53(127.0.1.1)\n;; WHEN: Sun Nov 27 00:57:16 EST 2016\n;; MSG SIZE  rcvd: 353</code></pre></div>\n<p>Check #1.</p>\n<p>To test SSL we don’t need to enforce SSL to test that it works, we can in theory setup SSL certs but don’t enforce it, this way\nour app can still stay in production to serve regular http request without anything breaking.</p>\n<p>All we need to do is just hit it with <code class=\"language-text\">https://</code> and see if the cert breaks or not. The normal traffic will just flow from <code class=\"language-text\">http://</code> without an issues.</p>\n<p>Check #2.</p>\n<h2>SSL options</h2>\n<p>Last step is to browse through the SSL options we are given.</p>\n<p>The initial options are given to me with a Heroku plugin called:</p>\n<ul>\n<li>ExpediateSSL at $15/month. This gives you a SSL cert along with automagically integrating all the settings. Though it is a bit more black box.</li>\n<li>Lets Encrypt + Heroku SSL SNI</li>\n</ul>\n<p>ExpediateSSL most likely works by similar methods, as they have a video about setup in <a href=\"https://www.youtube.com/watch?v=OcyR7Yus4pc\">3 minute setup</a>, but some issues made it not work, so I checked out the alternative setup.\nThe issue seems to be that, expediateSSL seems to require the SSL-Endpoint, so in the note on the documentation.</p>\n<blockquote>\n<p>NOTE: Expedited SSL works with your Heroku SSL Endpoint. If one is not already a part of your application, one will be added at its base monthly cost.</p>\n</blockquote>\n<p>In total, the expediated SSL + SSL-Endpoint runs at an additional $35/mo, since the app is still in the hobby phase, we can cut that cost with the letsencrypt method, until the day we actually need to support legacy browsers and have automated cert updates to CloudFront.</p>\n<p>With a bit more doc reading (I am a weird person, I like reading docs while listening to <a href=\"http://www.indieshuffle.com/playlists/readingdocs-115588/\">music</a>.)\nWe also have the service provided by letsencrypt, <a href=\"https://letsencrypt.org/\">Let’s Encrypt</a> is a free, automated, and open Certificate Authority.\nTheir setup is a bit more involved, but it is well worth it! Plus this SSL knowledge can then be applied to every app idea you have thus forth.\nPersonally I’m of the mentality to learn it the hard way, as infrastructure is black box most of the time. Gotta show that all the wasted time on reading tech docs isn’t actually a waste!</p>\n<blockquote>\n<p>Since Let’s Encrypt is backed by Chrome, Mozilla, Akamai\nand other major browser and CDN vendors, we can have a higher confidence that a browser update won’t redact our SSL certs. e.g. <a href=\"https://sslmate.com/blog/post/ct_redaction_in_chrome_53\">Chrome 53 rejects Chase online bankings Symantec SSL Certs.</a></p>\n</blockquote>\n<p>A sample of the setup I used is found on medium.com on a <a href=\"https://medium.com/@franxyzxyz/setting-up-free-https-with-heroku-ssl-and-lets-encrypt-80cf6eac108e#.v9azmm96o\">letsencrypt example with heroku post</a>,\nthis tut meshes well with a sample that is tailored to rails apps <a href=\"http://collectiveidea.com/blog/archives/2016/01/12/lets-encrypt-with-a-rails-app-on-heroku\">letsencrypt with heroku and rails</a>.</p>\n<p>Though essentially, the following steps were used.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$&gt; sudo apt-get install letsencrypt\n\n# Hit the above links for pictures!\n$&gt; sudo letsencrypt certonly  --manual\n...\nMake sure your web server displays the following content at\nhttp://www.example.com/.well-known/acme-challenge/xxxxxxxxxxxx-yyyy.zzzzzzzzzzzzzzzzzzz before continuing:\nxxxxxxxxxxxx-yyyy.zzzzzzzzzzzzzzzzzzz\nIf you don’t have HTTP server configuredundefined you can run the following\ncommand on the target server (as root):\nmkdir -p /tmp/certbot/public_html/.well-known/acme-challenge\ncd /tmp/certbot/public_html\nprintf “%s” Gm35kFLiXnNtKT9OAOG_KPZvqMmYYAZU6DN-QRoGclg.s2I4ZV9Ne2CNtczlqXV9uw1ZdB5OSypG_cIdiuT7BwI &gt; .well-known/acme-challenge/Gm35kFLiXnNtKT9OAOG_KPZvqMmYYAZU6DN-QRoGclg\n# run only once per server:\n$(command -v python2 || command -v python2.7 || command -v python2.6) -c \\\n“import BaseHTTPServerundefined SimpleHTTPServer; \\\ns = BaseHTTPServer.HTTPServer((‘’undefined 80)undefined SimpleHTTPServer.SimpleHTTPRequestHandler); \\\ns.serve_forever()”\nPress ENTER to continue</code></pre></div>\n<p>In rails, add these files:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># config/routes.rb</span>\nget <span class=\"token string\">'/.well-known/acme-challenge/:id'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'pages#letsencrypt'</span></code></pre></div>\n<p>In the controllers, add the following method.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token keyword\">class</span> <span class=\"token class-name\">PagesController</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ApplicationController</span>\n    <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">letsencrypt</span></span>\n      <span class=\"token comment\"># use your code here, not mine</span>\n      render text<span class=\"token punctuation\">:</span> <span class=\"token string\">\"ya6k1edW38z-your-value-here\"</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span></code></pre></div>\n<p>Now deploy your app on heroku, then continue the letsencrypt workflow. An automated agent will hit your server with your domain name just to verify that you own it. The challenge above needs to be returned.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">IMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at\n   /etc/letsencrypt/live/www.example.com/fullchain.pem. Your cert will\n   expire on 2016-04-11. To obtain a new version of the certificate in\n   the futureundefined simply run Let&#39;s Encrypt again.</code></pre></div>\n<p>All your certs will live in /etc/letsencrypt/live/www.example.com/*.pem, this directory should be centralized and backed up.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># upload certs to the mothership\n$&gt; sudo heroku certs:add /etc/letsencrypt/live/www.example.com/fullchain.pem</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$&gt; curl -vI https://www.example.com\n\n# boom.</code></pre></div>\n<p>When you need to upgrade the cert.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo letsencrypt certonly --manual -d www.example.com</code></pre></div>\n<p>Free certs for all your domains, no $35/mo issues.</p>\n<p>When you need to update the cert to match new subdomains</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo letsencrypt certonly --expand -d www.example.com</code></pre></div>","frontmatter":{"title":"Setup SSL on Heroku with letsencrypt and Rails","date":"November 26, 2016"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2016-11-26-setup-ssl-on-heroku-with-letsencrypt/","previous":{"fields":{"slug":"/2016-07-11-trigger-lambda-on-instance-termination/"},"frontmatter":{"title":"Trigger Lambda on Instance Termination."}},"next":null}}}