<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}</style><title data-react-helmet="true">Trigger Lambda on Instance Termination. | Blog</title><style data-styled="bbYQNF glPZkW xoySn dZslUP cyXmc cbktDA loXcrU cFKDbR iObEbj grOPvE hCgobX hUgFXe gKsasv ljNpVC eNxybB cWewoj hBoNzk iXDzJJ jWWWuy cjGNpn dSqUbD kuHnFT" data-styled-version="4.4.1">
/* sc-component-id: sc-bdVaJa */
.iXDzJJ{box-sizing:border-box;margin:0;}.jWWWuy{box-sizing:border-box;margin:0;margin-top:32px;margin-bottom:32px;}.cjGNpn{box-sizing:border-box;margin:0;background-color:#1F2041;}
/* sc-component-id: sc-bwzfXH */
.dZslUP{box-sizing:border-box;margin:0;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.cyXmc{box-sizing:border-box;margin:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.cbktDA{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.loXcrU{box-sizing:border-box;margin:0;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.cFKDbR{box-sizing:border-box;margin:0;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:space-between;-webkit-box-align:space-between;-ms-flex-align:space-between;align-items:space-between;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.iObEbj{box-sizing:border-box;margin:0;-webkit-flex-direction:columns;-ms-flex-direction:columns;flex-direction:columns;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:32px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}
/* sc-component-id: Text-sc-1c426xn-0 */
.cWewoj{box-sizing:border-box;margin:0;color:#8F8FA0;margin-bottom:8px;font-family:"Montserrat","avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;padding-top:8px;padding-bottom:8px;}.hBoNzk{box-sizing:border-box;margin:0;font-family:"Montserrat","avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;padding-top:8px;padding-bottom:8px;}
/* sc-component-id: Text__Head1-sc-1c426xn-1 */
.eNxybB{box-sizing:border-box;margin:0;padding-top:32px;padding-bottom:32px;font-size:42px;font-weight:1;font-family:"Quicksand",roboto,"avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;}
/* sc-component-id: Text__Head2-sc-1c426xn-2 */
.grOPvE{box-sizing:border-box;margin:0;padding-top:0;padding-bottom:0;font-size:20px;color:#000e1a;font-weight:1;font-family:"Quicksand",roboto,"avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;} @media screen and (min-width:32em){.grOPvE{font-size:24px;}}.hCgobX{box-sizing:border-box;margin:0;font-size:32px;font-weight:1;font-family:"Quicksand",roboto,"avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;padding-top:16px;padding-bottom:16px;}
/* sc-component-id: Text__Head5-sc-1c426xn-5 */
.kuHnFT{box-sizing:border-box;margin:0;color:#fff;font-weight:200;font-size:16px;font-family:"Montserrat","avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;padding-top:8px;padding-bottom:8px;}
/* sc-component-id: primitives__ShadowFlex-sc-1e3mgtb-0 */
.glPZkW{box-sizing:border-box;margin:0;background-color:#fff;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-shadow:0px 0px 10px 0px rgba(8,8,8,0.25);}
/* sc-component-id: primitives__ShadowBox-sc-1e3mgtb-1 */
.gKsasv{box-sizing:border-box;margin:0;background-color:#F4F4F5;overflow:hidden;max-height:10vh;margin-bottom:0;box-shadow:inset 0px -10px 10px -10px rgba(8,8,8,0.25);} @media screen and (min-width:32em){.gKsasv{max-height:20vh;margin-bottom:8px;}} @media screen and (min-width:48em){.gKsasv{max-height:30vh;margin-bottom:32px;}}
/* sc-component-id: primitives__Container-sc-1e3mgtb-4 */
.ljNpVC{box-sizing:border-box;margin:0;padding-left:32px;padding-right:32px;width:100%;} @media screen and (min-width:32em){.ljNpVC{width:100%;}} @media screen and (min-width:48em){.ljNpVC{width:960px;}}
/* sc-component-id: LinkAnimated-kistx3-0 */
.hUgFXe{-webkit-text-decoration:none;text-decoration:none;position:relative;margin-bottom:0;padding-bottom:5px;color:inherit;box-shadow:none;-webkit-transition:0.4s;transition:0.4s;cursor:pointer;} .hUgFXe:after{content:'';position:absolute;right:0;width:0;bottom:-5px;background:#6FCF97;height:5px;-webkit-transition-property:width;transition-property:width;-webkit-transition-duration:0.3s;transition-duration:0.3s;-webkit-transition-timing-function:ease-out;transition-timing-function:ease-out;} .hUgFXe:hover:after{left:0;right:auto;width:100%;}
/* sc-component-id: Header__HeaderContainer-sc-5ltj5t-0 */
.bbYQNF{background:#fff;position:absolute;width:100%;}
/* sc-component-id: Header__HeadSizeContainer-sc-5ltj5t-1 */
.xoySn{box-sizing:border-box;margin:0;padding:32px;width:100%;} @media screen and (min-width:32em){.xoySn{width:100%;}} @media screen and (min-width:48em){.xoySn{width:960px;}}
/* sc-component-id: MarkdownRenderer__DivOverlay-is9doz-0 */
.dSqUbD{box-sizing:border-box;margin:0;font-family:"Montserrat","avenir next",avenir,"helvetica neue",helvetica,ubuntu,noto,"segoe ui",arial,sans-serif;font-size:16px;}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><meta name="generator" content="Gatsby 2.18.6"/><meta data-react-helmet="true" name="description" content="Introduction So going on call, we had autoscaling groups that will terminate instances when they fail ELB health checks.
By the time that we got to the…"/><meta data-react-helmet="true" property="og:title" content="Trigger Lambda on Instance Termination."/><meta data-react-helmet="true" property="og:description" content="Introduction So going on call, we had autoscaling groups that will terminate instances when they fail ELB health checks.
By the time that we got to the…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Nick Ma"/><meta data-react-helmet="true" name="twitter:title" content="Trigger Lambda on Instance Termination."/><meta data-react-helmet="true" name="twitter:description" content="Introduction So going on call, we had autoscaling groups that will terminate instances when they fail ELB health checks.
By the time that we got to the…"/><style data-href="/styles.127328cee0e673d40f3e.css">@font-face{font-family:Quicksand;font-style:normal;font-display:swap;font-weight:300;src:local("Quicksand Light "),local("Quicksand-Light"),url(/static/quicksand-latin-300-ca35298d82cb431520acdb97fabf52f6.woff2) format("woff2"),url(/static/quicksand-latin-300-253b7a2b3807f337f50e6398a6be49cd.woff) format("woff")}@font-face{font-family:Quicksand;font-style:normal;font-display:swap;font-weight:400;src:local("Quicksand Regular "),local("Quicksand-Regular"),url(/static/quicksand-latin-400-d8b2688a6b382bdbdfeeae67ea6579c7.woff2) format("woff2"),url(/static/quicksand-latin-400-585c88473778ac67a8a25767f154c03d.woff) format("woff")}@font-face{font-family:Quicksand;font-style:normal;font-display:swap;font-weight:500;src:local("Quicksand Medium "),local("Quicksand-Medium"),url(/static/quicksand-latin-500-3e61524caf9c637fa42920c2e72cfa02.woff2) format("woff2"),url(/static/quicksand-latin-500-f0955088b6b4279d3e4a6a934fb9d32b.woff) format("woff")}@font-face{font-family:Quicksand;font-style:normal;font-display:swap;font-weight:700;src:local("Quicksand Bold "),local("Quicksand-Bold"),url(/static/quicksand-latin-700-e31d1d2bad196c192b8c8ca4036678da.woff2) format("woff2"),url(/static/quicksand-latin-700-d1ae23c7c4457c1fcc9b3ba85e3a3e83.woff) format("woff")}@font-face{font-family:Roboto;font-style:normal;font-display:swap;font-weight:100;src:local("Roboto Thin "),local("Roboto-Thin"),url(/static/roboto-latin-100-987b84570ea69ee660455b8d5e91f5f1.woff2) format("woff2"),url(/static/roboto-latin-100-e9dbbe8a693dd275c16d32feb101f1c1.woff) format("woff")}@font-face{font-family:Roboto;font-style:italic;font-display:swap;font-weight:100;src:local("Roboto Thin italic"),local("Roboto-Thinitalic"),url(/static/roboto-latin-100italic-6232f43d15b0e7a0bf0fe82e295bdd06.woff2) format("woff2"),url(/static/roboto-latin-100italic-d704bb3d579b7d5e40880c75705c8a71.woff) format("woff")}@font-face{font-family:Roboto;font-style:normal;font-display:swap;font-weight:300;src:local("Roboto Light "),local("Roboto-Light"),url(/static/roboto-latin-300-55536c8e9e9a532651e3cf374f290ea3.woff2) format("woff2"),url(/static/roboto-latin-300-a1471d1d6431c893582a5f6a250db3f9.woff) format("woff")}@font-face{font-family:Roboto;font-style:italic;font-display:swap;font-weight:300;src:local("Roboto Light italic"),local("Roboto-Lightitalic"),url(/static/roboto-latin-300italic-d69924b98acd849cdeba9fbff3f88ea6.woff2) format("woff2"),url(/static/roboto-latin-300italic-210a7c781f5a354a0e4985656ab456d9.woff) format("woff")}@font-face{font-family:Roboto;font-style:normal;font-display:swap;font-weight:400;src:local("Roboto Regular "),local("Roboto-Regular"),url(/static/roboto-latin-400-5d4aeb4e5f5ef754e307d7ffaef688bd.woff2) format("woff2"),url(/static/roboto-latin-400-bafb105baeb22d965c70fe52ba6b49d9.woff) format("woff")}@font-face{font-family:Roboto;font-style:italic;font-display:swap;font-weight:400;src:local("Roboto Regular italic"),local("Roboto-Regularitalic"),url(/static/roboto-latin-400italic-d8bcbe724fd6f4ba44d0ee6a2675890f.woff2) format("woff2"),url(/static/roboto-latin-400italic-9680d5a0c32d2fd084e07bbc4c8b2923.woff) format("woff")}@font-face{font-family:Roboto;font-style:normal;font-display:swap;font-weight:500;src:local("Roboto Medium "),local("Roboto-Medium"),url(/static/roboto-latin-500-285467176f7fe6bb6a9c6873b3dad2cc.woff2) format("woff2"),url(/static/roboto-latin-500-de8b7431b74642e830af4d4f4b513ec9.woff) format("woff")}@font-face{font-family:Roboto;font-style:italic;font-display:swap;font-weight:500;src:local("Roboto Medium italic"),local("Roboto-Mediumitalic"),url(/static/roboto-latin-500italic-510dec37fa69fba39593e01a469ee018.woff2) format("woff2"),url(/static/roboto-latin-500italic-ffcc050b2d92d4b14a4fcb527ee0bcc8.woff) format("woff")}@font-face{font-family:Roboto;font-style:normal;font-display:swap;font-weight:700;src:local("Roboto Bold "),local("Roboto-Bold"),url(/static/roboto-latin-700-037d830416495def72b7881024c14b7b.woff2) format("woff2"),url(/static/roboto-latin-700-cf6613d1adf490972c557a8e318e0868.woff) format("woff")}@font-face{font-family:Roboto;font-style:italic;font-display:swap;font-weight:700;src:local("Roboto Bold italic"),local("Roboto-Bolditalic"),url(/static/roboto-latin-700italic-010c1aeee3c6d1cbb1d5761d80353823.woff2) format("woff2"),url(/static/roboto-latin-700italic-846d1890aee87fde5d8ced8eba360c3a.woff) format("woff")}@font-face{font-family:Roboto;font-style:normal;font-display:swap;font-weight:900;src:local("Roboto Black "),local("Roboto-Black"),url(/static/roboto-latin-900-19b7a0adfdd4f808b53af7e2ce2ad4e5.woff2) format("woff2"),url(/static/roboto-latin-900-8c2ade503b34e31430d6c98aa29a52a3.woff) format("woff")}@font-face{font-family:Roboto;font-style:italic;font-display:swap;font-weight:900;src:local("Roboto Black italic"),local("Roboto-Blackitalic"),url(/static/roboto-latin-900italic-7b770d6c53423deb1a8e49d3c9175184.woff2) format("woff2"),url(/static/roboto-latin-900italic-bc833e725c137257c2c42a789845d82f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}</style><link as="script" rel="preload" href="/component---src-templates-blog-post-js-d1760038206415fe1a4a.js"/><link as="script" rel="preload" href="/commons-91f8b1f6c8b6ec600faa.js"/><link as="script" rel="preload" href="/app-691e6b399dd07ebf95b5.js"/><link as="script" rel="preload" href="/styles-4984752a97d9a8623744.js"/><link as="script" rel="preload" href="/webpack-runtime-8948f698bb90a6d34b79.js"/><link as="fetch" rel="preload" href="/page-data/2016/07/11/trigger-lambda-on-instance-termination/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><main><div class="Header__HeaderContainer-sc-5ltj5t-0 bbYQNF headroom-wrapper"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translate3D(0, 0, 0);-ms-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)" class="headroom headroom--unfixed"><div class="sc-bdVaJa sc-bwzfXH primitives__ShadowFlex-sc-1e3mgtb-0 glPZkW"><div width="100%,100%,960px" class="sc-bdVaJa Header__HeadSizeContainer-sc-5ltj5t-1 xoySn"><div class="sc-bdVaJa sc-bwzfXH dZslUP"><div class="sc-bdVaJa sc-bwzfXH cyXmc"><h2 font-size="3,4" color="black" font-weight="0" font-family="sansSerifSecondary" class="sc-bdVaJa sc-htpNat Text__Head2-sc-1c426xn-2 grOPvE"><a class="LinkAnimated-kistx3-0 hUgFXe" href="/">Nick Ma&#x27;s Blog</a></h2></div></div></div></div></div></div><div overflow="hidden" class="sc-bdVaJa primitives__ShadowBox-sc-1e3mgtb-1 gKsasv"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div style="width:100%;padding-bottom:66.66666666666667%"></div><img src="data:image/webp;base64,UklGRnYAAABXRUJQVlA4IGoAAAAQBACdASoUAA0APtFUo0uoJKMhsAgBABoJZACdMoLT9AuK69CQ8CS+cAD+qEP3whHgfgzYgjSzbZPT1vU1nqeLq+ieMYsKuHv+R4He/2ZdfHjK2fPkidXZCMbrkIw/lwNRc1iPB3NYgzwA" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/235fcc9a13606a3291610817ad172b1e/ad85c/photo-1523821741446-edb2b68bb7a0.webp 600w,
/static/235fcc9a13606a3291610817ad172b1e/99238/photo-1523821741446-edb2b68bb7a0.webp 1200w,
/static/235fcc9a13606a3291610817ad172b1e/f1e40/photo-1523821741446-edb2b68bb7a0.webp 2400w,
/static/235fcc9a13606a3291610817ad172b1e/d4378/photo-1523821741446-edb2b68bb7a0.webp 3600w,
/static/235fcc9a13606a3291610817ad172b1e/8deb6/photo-1523821741446-edb2b68bb7a0.webp 3750w" sizes="(max-width: 2400px) 100vw, 2400px" /><img loading="lazy" sizes="(max-width: 2400px) 100vw, 2400px" srcset="/static/235fcc9a13606a3291610817ad172b1e/ad85c/photo-1523821741446-edb2b68bb7a0.webp 600w,
/static/235fcc9a13606a3291610817ad172b1e/99238/photo-1523821741446-edb2b68bb7a0.webp 1200w,
/static/235fcc9a13606a3291610817ad172b1e/f1e40/photo-1523821741446-edb2b68bb7a0.webp 2400w,
/static/235fcc9a13606a3291610817ad172b1e/d4378/photo-1523821741446-edb2b68bb7a0.webp 3600w,
/static/235fcc9a13606a3291610817ad172b1e/8deb6/photo-1523821741446-edb2b68bb7a0.webp 3750w" src="/static/235fcc9a13606a3291610817ad172b1e/f1e40/photo-1523821741446-edb2b68bb7a0.webp" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div><div class="sc-bdVaJa sc-bwzfXH cbktDA"><div width="100%,100%,960px" class="sc-bdVaJa primitives__Container-sc-1e3mgtb-4 ljNpVC"><h1 font-size="6" font-weight="0" font-family="sansSerifSecondary" class="sc-bdVaJa sc-htpNat Text__Head1-sc-1c426xn-1 eNxybB">Trigger Lambda on Instance Termination.</h1><p color="greyscale-dark" font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 cWewoj">July 11, 2016</p><div class="sc-bdVaJa iXDzJJ"><div><div font-family="sansSerif" font-size="2" class="sc-bdVaJa MarkdownRenderer__DivOverlay-is9doz-0 dSqUbD"><h2 font-size="5" font-weight="0" font-family="sansSerifSecondary" class="sc-bdVaJa sc-htpNat Text__Head2-sc-1c426xn-2 hCgobX">Introduction</h2>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">So going on call, we had autoscaling groups that will terminate instances when they fail ELB health checks.
By the time that we got to the instances, they were already terminated and we have no access to the logs.</p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">My ideal solution would be to find time to setup the Elasticsearch LogStash Kibana (ELK) stack. Though since,
the company only had 15 developers and only 2 of them know how the infrastructure works. The idea won’t get much
traction. For a working ELK come to fruition we needed to pull hours of research outside of working hours
without support.
This wasn’t something I wanted to do, since it will affect my ability to do actual assigned work, as much as it pains
me, I need to get things done and clear time to pursue other options.</p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">So for the simplest thing that gets 80 percent of the results, I used a SNS triggered lambda function to scrap all
logs for terminating instances. This is done through the use of AWS Autoscaling’s Lifecycle hooks.</p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk"><img src="http://docs.aws.amazon.com/autoscaling/latest/userguide/images/lifecycle_hooks.png" alt="lifecycle-hooks"/></p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">For every AutoScaling Group, there are listeners on these event hooks that can be used to program in behaviour.
In my example I setup a termination hook on the Cloudformation containing all my AutoScaling Groups.</p>
<div class="sc-bdVaJa MarkdownRenderer__DivOverlay-is9doz-0 dSqUbD gatsby-highlight" data-language="json" font-family="sansSerif" font-size="2"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;Group1LifeCycleTerminationHook&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AWS::AutoScaling::LifecycleHook&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;AutoScalingGroupName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Group1ServerGroup&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;HeartbeatTimeout&quot;</span><span class="token operator">:</span> <span class="token number">240</span><span class="token punctuation">,</span>
      <span class="token property">&quot;LifecycleTransition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;autoscaling:EC2_INSTANCE_TERMINATING&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;NotificationTargetARN&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TerminationHookSNSTopic&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;RoleARN&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TerminationHookRole&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">You can setup the LifeCycle through the
<a href="http://docs.aws.amazon.com/cli/latest/reference/autoscaling/put-lifecycle-hook.html">CLI</a><br/>
as well, but there is no UI for this feature during the writing of this blog post.</p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">This function is then scheduled to trigger an
<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/install-ssm-agent.html">AWS SSM agent</a> script to scrape all my logs.
on my cluster of servers. Essentially, this agent awaits commands from the AWS SSM scheduler and executes preapproved
scripts on the specific set of EC2 machines.</p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">On each of my server provisioners on CloudFormation, I added the ssm-agent bootstrap script. So that the servers
respond to SSM requests.</p>
<div class="sc-bdVaJa MarkdownRenderer__DivOverlay-is9doz-0 dSqUbD gatsby-highlight" data-language="json" font-family="sansSerif" font-size="2"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;/opt/ssm/install-ssm-agent.sh&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;Fn::Join&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token string">&quot;#!/bin/bash\n&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;cd /tmp\n&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;curl https://amazon-ssm-&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;Ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AWS::Region&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;.s3.amazonaws.com/latest/linux_amd64/amazon-ssm-agent.rpm -o amazon-ssm-agent.rpm\n&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;yum install -y amazon-ssm-agent.rpm\n&quot;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;owner&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;group&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;000755&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">I then setup my SSM Document to perform a task, and upload it to the SSM document store.</p>
<div class="sc-bdVaJa MarkdownRenderer__DivOverlay-is9doz-0 dSqUbD gatsby-highlight" data-language="json" font-family="sansSerif" font-size="2"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">&quot;Content&quot;</span><span class="token operator">:</span> &quot;<span class="token punctuation">{</span>
        \&quot;schemaVersion\&quot;<span class="token operator">:</span> \&quot;<span class="token number">1.2</span>\&quot;<span class="token punctuation">,</span>
    \&quot;description\&quot;<span class="token operator">:</span> \&quot;Clean up jobs for a terminating instance.\&quot;<span class="token punctuation">,</span>
    \&quot;parameters\&quot;<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    \&quot;runtimeConfig\&quot;<span class="token operator">:</span> <span class="token punctuation">{</span>
        \&quot;aws<span class="token operator">:</span>runShellScript\&quot;<span class="token operator">:</span> <span class="token punctuation">{</span>
        \&quot;properties\&quot;<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            \&quot;id\&quot;<span class="token operator">:</span> \&quot;<span class="token number">0.</span>aws<span class="token operator">:</span>runShellScript\&quot;<span class="token punctuation">,</span>
          \&quot;runCommand\&quot;<span class="token operator">:</span> <span class="token punctuation">[</span>
                \&quot;echo &#x27;===CATALINA.OUT===&#x27;\&quot;<span class="token punctuation">,</span>
                \&quot;tail -n <span class="token number">1000</span> /var/log/tomcat/catalina.out || <span class="token boolean">true</span>\&quot;<span class="token punctuation">,</span>
                \&quot;echo &#x27;===JETTY.LOGs===&#x27;\&quot;<span class="token punctuation">,</span>
                \&quot;tail -n <span class="token number">1000</span> /var/log/jetty/`ls /var/log/jetty/ | sort -r | head -n <span class="token number">1</span>` || <span class="token boolean">true</span>\&quot;<span class="token punctuation">,</span>
                \&quot;echo &#x27;===FREEMEMORY===&#x27;\&quot;<span class="token punctuation">,</span>
                \&quot;free -m\&quot;<span class="token punctuation">,</span>
                \&quot;echo &#x27;===DOCKER-INSPECT===&#x27;\&quot;<span class="token punctuation">,</span>
                \&quot;docker inspect tomcat || <span class="token boolean">true</span>\&quot;<span class="token punctuation">,</span>
                \&quot;docker inspect jetty || <span class="token boolean">true</span>\&quot;<span class="token punctuation">,</span>
                \&quot;echo &#x27;===FILE DESCRIPTORS===&#x27;\&quot;<span class="token punctuation">,</span>
                \&quot;lsof | wc -l\&quot;
                  <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>&quot;<span class="token punctuation">,</span>
    <span class="token property">&quot;Name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scrape-terminating-instance-logs&quot;</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="sc-bdVaJa MarkdownRenderer__DivOverlay-is9doz-0 dSqUbD gatsby-highlight" data-language="bash" font-family="sansSerif" font-size="2"><pre class="language-bash"><code class="language-bash">aws --profile prod ec2 ssm create-document --content file://scrape-terminating-instance-logs.json --name <span class="token string">&quot;scrape-terminating-instance-logs&quot;</span></code></pre></div>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">Now I trigger the SSM run from my Lambda Method, and setting the SNS notfication as the Lambda Method trigger.</p>
<div class="sc-bdVaJa MarkdownRenderer__DivOverlay-is9doz-0 dSqUbD gatsby-highlight" data-language="python" font-family="sansSerif" font-size="2"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function

<span class="token keyword">import</span> json

<span class="token comment"># Message Sample</span>
<span class="token triple-quoted-string string">&#x27;&#x27;&#x27;
Service: AWS Auto Scaling
Time: 2016-01-27T15:23:47.581Z
RequestId: reqid
LifecycleActionToken: someToken
AccountId: 123
AutoScalingGroupName: Group1
LifecycleHookName: Group1LifeCycleTerminationHook
EC2InstanceId: i-1ba03992
LifecycleTransition: autoscaling:EC2_INSTANCE_TERMINATING
NotificationMetadata: null
&#x27;&#x27;&#x27;</span>
ASG_NAME_KEY<span class="token operator">=</span><span class="token string">&#x27;AutoScalingGroupName&#x27;</span>
EC2_INSTANCE_ID_KEY<span class="token operator">=</span><span class="token string">&#x27;EC2InstanceId&#x27;</span>
<span class="token keyword">import</span> boto3

client <span class="token operator">=</span> boto3<span class="token punctuation">.</span>client<span class="token punctuation">(</span><span class="token string">&#x27;ssm&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">lambda_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;boto3 version: %s&#x27;</span> <span class="token operator">%</span> boto3<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>
    <span class="token comment">#print(&quot;Received event: &quot; + json.dumps(event, indent=2))</span>
    message <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">&#x27;Records&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#x27;Sns&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#x27;Message&#x27;</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>

    json_message <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    asg_name <span class="token operator">=</span> json_message<span class="token punctuation">[</span>ASG_NAME_KEY<span class="token punctuation">]</span>
    ec2_id <span class="token operator">=</span> json_message<span class="token punctuation">[</span>EC2_INSTANCE_ID_KEY<span class="token punctuation">]</span>

    response <span class="token operator">=</span> client<span class="token punctuation">.</span>send_command<span class="token punctuation">(</span>
        InstanceIds<span class="token operator">=</span><span class="token punctuation">[</span>
            ec2_id<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        DocumentName<span class="token operator">=</span><span class="token string">&#x27;scrape-terminating-instance-logs&#x27;</span><span class="token punctuation">,</span>
        TimeoutSeconds<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span>
        Comment<span class="token operator">=</span><span class="token string">&#x27;scrape log lines and other auditing info&#x27;</span><span class="token punctuation">,</span>
        Parameters<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        OutputS3BucketName<span class="token operator">=</span><span class="token string">&#x27;somebucket&#x27;</span><span class="token punctuation">,</span>
        OutputS3KeyPrefix<span class="token operator">=</span><span class="token string">&#x27;terminated_instance_logs/&#x27;</span> <span class="token operator">+</span> asg_name
    <span class="token punctuation">)</span>
    <span class="token comment"># remove dates that are break json serialization</span>
    response<span class="token punctuation">[</span><span class="token string">&#x27;Command&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&quot;RequestedDateTime&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    response<span class="token punctuation">[</span><span class="token string">&#x27;Command&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&quot;ExpiresAfter&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

    <span class="token keyword">return</span> response</code></pre></div>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">The above lambda method will trigger the SSM function every time an event occurs, it can also be updated to trigger
any clean up function needed.</p>
<p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">If you read the above lambda method, you will notice that I set the SSM client to output the results to a s3 bucket,
this bucket can then be accessed anytime to read the last bit of logs prior to the instance terminating.</p></div></div></div><hr class="sc-bdVaJa jWWWuy"/><div width="100%,100%,960px" class="sc-bdVaJa primitives__Container-sc-1e3mgtb-4 ljNpVC"><div class="sc-bdVaJa sc-bwzfXH loXcrU"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEBf/EABcBAQEBAQAAAAAAAAAAAAAAAAACAQP/2gAMAwEAAhADEAAAAaW49CjEOvlOdZBWf//EABoQAQEBAQADAAAAAAAAAAAAAAIBAxESExT/2gAIAQEAAQUCLny5OGbuXU6dPtpSvbch4rI9onf/xAAWEQEBAQAAAAAAAAAAAAAAAAARABD/2gAIAQMBAT8BI3//xAAWEQEBAQAAAAAAAAAAAAAAAAARABD/2gAIAQIBAT8BZ3//xAAaEAACAgMAAAAAAAAAAAAAAAAAEQFBEBIx/9oACAEBAAY/AlYlTJNRjOZ//8QAGhAAAwEBAQEAAAAAAAAAAAAAAAERIUExwf/aAAgBAQABPyFWXH0UU06DFSwdqiQ5CPJpX8U2M4Ws7Bfo/9oADAMBAAIAAwAAABDQKIH/xAAXEQEBAQEAAAAAAAAAAAAAAAAAAREx/9oACAEDAQE/EOEhGP/EABcRAQEBAQAAAAAAAAAAAAAAAAABMRH/2gAIAQIBAT8Q06XEtf/EAB0QAQACAgMBAQAAAAAAAAAAAAEAESExQVFxwdH/2gAIAQEAAT8QShZtVbhMiCzFXcU8JKHyPWepyPcQ6GrYdfkwydA3UWgUbHofZvfDpfEQBQ9n/9k=" alt="Nick Ma" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/c9f24f4b4d7388292878c428fc5392dd/30d3a/profile-pic.jpg 1x,
/static/c9f24f4b4d7388292878c428fc5392dd/66c95/profile-pic.jpg 1.5x,
/static/c9f24f4b4d7388292878c428fc5392dd/aacbd/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/c9f24f4b4d7388292878c428fc5392dd/30d3a/profile-pic.jpg 1x,
/static/c9f24f4b4d7388292878c428fc5392dd/66c95/profile-pic.jpg 1.5x,
/static/c9f24f4b4d7388292878c428fc5392dd/aacbd/profile-pic.jpg 2x" src="/static/c9f24f4b4d7388292878c428fc5392dd/30d3a/profile-pic.jpg" alt="Nick Ma" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div class="sc-bdVaJa sc-bwzfXH cFKDbR"><div class="sc-bdVaJa iXDzJJ"><p font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text-sc-1c426xn-0 hBoNzk">Written by <strong>Nick Ma</strong> 🤓, who likes learning boring complicated stuff and making it sound easy. 💻 🤔<!-- --> <a href="https://twitter.com/nma38">You should follow him on Twitter</a></p></div></div></div></div></div></div><div class="sc-bdVaJa sc-bwzfXH cbktDA"><div width="100%,100%,960px" class="sc-bdVaJa Header__HeadSizeContainer-sc-5ltj5t-1 xoySn"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2016/07/07/vim-save-as-sudo">← <!-- -->Vim Save as Sudo</a></li><li><a rel="next" href="/2016/11/26/setup-ssl-on-heroku-with-letsencrypt">Setup SSL on Heroku with letsencrypt and Rails<!-- --> →</a></li></ul></div></div><div class="sc-bdVaJa cjGNpn"><div class="sc-bdVaJa sc-bwzfXH iObEbj"><h5 color="white" font-weight="3" font-size="2" font-family="sansSerif" class="sc-bdVaJa sc-htpNat Text__Head5-sc-1c426xn-5 kuHnFT">Copyright © 2019 Nick Ma.</h5></div></div></main></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2016/07/11/trigger-lambda-on-instance-termination";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-691e6b399dd07ebf95b5.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-25248a3ece515bddc791.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-d1760038206415fe1a4a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-d35d386be67a2a6d782f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-e67403cf96b6373add6a.js"]};/*]]>*/</script><script src="/webpack-runtime-8948f698bb90a6d34b79.js" async=""></script><script src="/styles-4984752a97d9a8623744.js" async=""></script><script src="/app-691e6b399dd07ebf95b5.js" async=""></script><script src="/commons-91f8b1f6c8b6ec600faa.js" async=""></script><script src="/component---src-templates-blog-post-js-d1760038206415fe1a4a.js" async=""></script></body></html>